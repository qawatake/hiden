# hiden CLI 仕様書

## 概要

`hiden` は、ghqで管理しているリポジトリ内の個人用メモ・スクリプト置き場（hidenディレクトリ）を横断的に検索・アクセスするためのCLIツール。

## 用語定義

- **hidenディレクトリ**: 各リポジトリ内に存在する、個人用のメモやスクリプトを保存するディレクトリ。各自が `.gitignore` で除外して使用する。

## 技術スタック

- 言語: Go
- インタラクティブ検索: [bubbletea](https://github.com/charmbracelet/bubbletea) + [lipgloss](https://github.com/charmbracelet/lipgloss) で独自実装（外部コマンド依存なし）
  - 検索方式: 入力文字列を必ず含む部分一致検索（大文字小文字を区別しない）
  - スペース区切りでAND検索
  - ソート順: 最終更新時刻の降順（固定）

## 設定ファイル

### パス

```
~/.config/hiden/config.json
```

### スキーマ

```json
{
  "dirname": ".hiden"
}
```

### フィールド

| フィールド | 型 | デフォルト値 | 説明 |
|-----------|------|-------------|------|
| `dirname` | string | `".hiden"` | hidenディレクトリの名前 |

### 挙動

- 設定ファイルが存在しない場合: デフォルト値を使用
- 設定ファイルが不正な場合: エラーを出力して終了

## コマンド

### `hiden ls`

hidenディレクトリ内のファイルをインクリメンタル検索し、選択したファイルの絶対パスを出力する。

#### 処理フロー

1. `ghq list --full-path` コマンドを実行し、全リポジトリの絶対パス一覧を取得
2. 各リポジトリ内のhidenディレクトリを検索
3. hidenディレクトリ内のファイルを再帰的に収集
4. タイムスタンプ（更新日時）の新しい順にソート
5. インクリメンタル検索UIを起動し、ユーザーに選択させる
6. 選択されたファイルのタイムスタンプを現在時刻に更新（`touch`相当）
7. 選択されたファイルの絶対パスを標準出力に出力

#### 表示形式

検索UIの各行には以下の情報を表示:

```
YYYY-MM-DD  relative/path/to/file  [repository-name]
```

例:
```
2025-12-04  memo.md           [my-project]
2025-12-03  scripts/build.sh  [another-repo]
2025-11-28  notes/idea.txt    [some-tool]
```

#### 終了コード

| コード | 条件 |
|-------|------|
| 0 | 正常終了（ファイル選択成功） |
| 1 | エラー終了（Ctrl+C による中断、その他のエラー） |

#### エラーケース

- `ghq` コマンドが見つからない、または `ghq list` が失敗した場合: エラーメッセージを出力して終了
- hidenディレクトリが1つも見つからない、またはファイルが1つも見つからない場合: 何も出力せず正常終了
- Ctrl+C で中断された場合: 何も出力せずエラー終了

#### 対象ファイル

- hidenディレクトリ内のすべてのファイル（再帰的）
- 隠しファイル（`.`で始まるファイル）も対象
- ディレクトリは対象外（ファイルのみ）
- hidenディレクトリがシンボリックリンクの場合、リンク先のディレクトリ内を探索する

### `hiden mkdir`

git repository内に日付ディレクトリを作成する。

#### 処理フロー

1. カレントディレクトリがgit repository内かをチェック
2. git repositoryでない場合はエラーを出力して終了
3. git repositoryのルートディレクトリを取得
4. `{リポジトリルート}/{hidenディレクトリ}/{コマンド実行日}` のディレクトリを作成
5. 作成されたディレクトリのリポジトリルートからの相対パスを標準出力に出力

#### ディレクトリ形式

```
{リポジトリルート}/{hidenディレクトリ名}/YYYY-MM-DD
```

例（hidenディレクトリが`.hiden`の場合）:
```
.hiden/2025-12-04
```

例（hidenディレクトリが`qwtk`の場合）:
```
qwtk/2025-12-04
```

#### 終了コード

| コード | 条件 |
|-------|------|
| 0 | 正常終了（ディレクトリ作成成功） |
| 1 | エラー終了 |

#### エラーケース

- カレントディレクトリがgit repository内でない場合: エラーメッセージを出力して終了
- ディレクトリ作成に失敗した場合: エラーメッセージを出力して終了

#### その他

- ディレクトリが既に存在する場合でもエラーとせず、そのパスを出力する

### `hiden mv <file>`

ファイルをhidenディレクトリの日付ディレクトリに移動する。

#### 処理フロー

1. カレントディレクトリがgit repository内かをチェック
2. git repositoryでない場合はエラーを出力して終了
3. `hiden mkdir` と同様に日付ディレクトリを作成（既に存在する場合はそのまま使用）
4. 指定されたファイルを日付ディレクトリに移動
5. 何も出力せず正常終了

#### 終了コード

| コード | 条件 |
|-------|------|
| 0 | 正常終了（ファイル移動成功） |
| 1 | エラー終了 |

#### エラーケース

- カレントディレクトリがgit repository内でない場合: エラーメッセージを出力して終了
- ファイルが指定されていない場合: エラーメッセージを出力して終了
- ファイルの移動に失敗した場合: エラーメッセージを出力して終了

### `hiden version`

バージョン情報を出力する。

```
hiden version X.Y.Z
```

### `hiden help` / `hiden -h` / `hiden --help`

ヘルプメッセージを出力する。

### 引数なしで実行した場合

ヘルプメッセージを出力して終了コード1で終了する。

## 使用例

### 基本的な使い方

```bash
# ファイルを検索して選択
$ hiden ls
# → インクリメンタル検索UIが起動
# → ファイルを選択すると絶対パスが出力される
/Users/user/src/github.com/org/repo/.hiden/memo.md

# エディタで開く
$ vim $(hiden ls)

# 設定を確認
$ cat ~/.config/hiden/config.json
{"dirname": ".hiden"}
```

## ディレクトリ構造例

```
~/src/github.com/
├── org1/
│   └── repo1/
│       ├── src/
│       ├── .gitignore      # .hiden/ を除外
│       └── .hiden/         # ← hidenディレクトリ
│           ├── memo.md
│           └── scripts/
│               └── test.sh
└── org2/
    └── repo2/
        ├── lib/
        ├── .gitignore      # .hiden/ を除外
        └── .hiden/         # ← hidenディレクトリ
            └── notes.txt
```
